<div class="container mt-4">
  <h2 class="mb-4">Manage ID Cards</h2>

  <!-- Form -->
  <div class="card mb-4">
    <div class="card-body">
      <form [formGroup]="idCardForm" (ngSubmit)="editingId ? update() : add()">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" formControlName="name">
          </div>
          <div class="col-md-8">
            <label class="form-label">Description</label>
            <input type="text" class="form-control" formControlName="description">
          </div>
          <div class="col-md-3">
            <label class="form-label">Status</label>
            <select class="form-select" formControlName="status">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>

        <!-- Subcollections -->
        <div class="mt-3" *ngFor="let sub of subCollections">
          <label class="form-label text-capitalize">{{ sub }}</label>
          <div [formArrayName]="sub">
            <div *ngFor="let f of getSubArray(sub).controls; let i = index" class="d-flex mb-2">
              <input class="form-control me-2" [formControlName]="i" placeholder="Enter colorderimage URL">
              <button type="button" class="btn btn-danger btn-sm" (click)="removeSubItem(sub, i)">X</button>
            </div>
          </div>
          <button type="button" class="btn btn-secondary btn-sm mt-2" (click)="addSubItem(sub)">+ Add {{ sub | slice:0:-1 }}</button>
        </div>

        <div class="mt-3">
          <button type="submit" class="btn btn-primary me-2" [disabled]="idCardForm.invalid">
            {{ editingId ? 'Update' : 'Add' }} ID Card
          </button>
          <button *ngIf="editingId" type="button" class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ID Card List -->
  <ng-container *ngIf="(idCards$ | async) as cards; else loading">
    <ng-container *ngIf="cards.length; else empty">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th>Description</th>
              <th>Status</th>
              <th class="text-center">Holders</th>
              <th class="text-center">Lanyards</th>
              <th class="text-center">Cards</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of cards; trackBy: trackById">
              <td><strong>{{ item.name }}</strong></td>
              <td class="text-truncate" style="max-width: 320px;" title="{{ item.description }}">{{ item.description }}</td>
              <td>
                <span class="badge" [ngClass]="item.status === 'active' ? 'text-bg-success' : 'text-bg-secondary'">{{ item.status }}</span>
              </td>
              <td class="text-center">
                <span *ngFor="let h of getSubArray('holders').value">
                  <img *ngIf="h.colorderimage" [src]="h.colorderimage" width="30" class="me-1 rounded-circle">
                </span>
              </td>
              <td class="text-center">
                <span *ngFor="let l of getSubArray('lanyards').value">
                  <img *ngIf="l.colorderimage" [src]="l.colorderimage" width="30" class="me-1 rounded-circle">
                </span>
              </td>
              <td class="text-center">
                <span *ngFor="let c of getSubArray('cards').value">
                  <img *ngIf="c.colorderimage" [src]="c.colorderimage" width="30" class="me-1 rounded-circle">
                </span>
              </td>
              <td class="text-end">
                <button class="btn btn-sm btn-warning me-2" (click)="edit(item)">Edit</button>
                <button class="btn btn-sm btn-danger" (click)="remove(item.id!)">Delete</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </ng-container>
  </ng-container>

  <ng-template #loading>
    <div class="alert alert-info">Loading ID cards...</div>
  </ng-template>
  <ng-template #empty>
    <div class="alert alert-secondary">No ID cards found. Add your first card above.</div>
  </ng-template>
</div>

