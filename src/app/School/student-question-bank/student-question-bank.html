<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="bi bi-journal-bookmark-fill me-2"></i> School Question Bank</h2>
  </div>

  <!-- Filter Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-funnel-fill me-2"></i> Filter Questions</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="filterType" class="form-label fw-bold">Question Type</label>
          <select id="filterType" class="form-select" [value]="selectedType() || 'All Types'" (change)="onTypeChange($event)">
            <option *ngFor="let type of questionTypes" [value]="type">{{ type }}</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filterClass" class="form-label fw-bold">Class</label>
          <select id="filterClass" class="form-select" [value]="selectedClass() || 'All'" (change)="onClassChange($event)">
            <option *ngFor="let class of availableClasses()" [value]="class">{{ class === 'All' ? 'All Classes' : class }}</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filterSubject" class="form-label fw-bold">Subject</label>
          <select id="filterSubject" class="form-select" [value]="selectedSubject() || 'All'" (change)="onSubjectChange($event)">
            <option *ngFor="let subject of availableSubjects()" [value]="subject">{{ subject === 'All' ? 'All Subjects' : subject }}</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filterChapter" class="form-label fw-bold">Chapter</label>
          <select id="filterChapter" class="form-select" [value]="selectedChapter() || 'All'" (change)="onChapterChange($event)">
            <option *ngFor="let chapter of availableChapters()" [value]="chapter">{{ chapter === 'All' ? 'All Chapters' : chapter }}</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filterTeacher" class="form-label fw-bold">Teacher</label>
          <select id="filterTeacher" class="form-select" [value]="selectedTeacher() || 'All'" (change)="onTeacherChange($event)">
            <option value="All">All Teachers</option>
            <option *ngFor="let teacher of availableTeachers()" [value]="teacher">{{ teacher }}</option>
          </select>
        </div>
      </div>
      <div class="mt-3 text-end">
        <button type="button" class="btn btn-outline-secondary" (click)="clearFilters()">Clear Filters</button>
      </div>
    </div>
  </div>

  <!-- Question Statistics Section -->
  <div *ngIf="!isLoadingFilters() && allApprovedQuestions().length > 0" class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-bar-chart-line-fill me-2"></i> Question Statistics</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-info d-flex align-items-center">
        <i class="bi bi-info-circle-fill fs-4 me-3"></i>
        <div>
          Total available questions in the bank: <strong class="fs-5">{{ allApprovedQuestions().length }}</strong>
        </div>
      </div>
      <div class="accordion" id="statsAccordion">
        <!-- By Subject -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingSubject">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubject" aria-expanded="false" aria-controls="collapseSubject">
              By Subject ({{ questionCountBySubject().size }})
            </button>
          </h2>
          <div id="collapseSubject" class="accordion-collapse collapse" aria-labelledby="headingSubject" data-bs-parent="#statsAccordion">
            <div class="accordion-body">
              <ul class="list-group list-group-flush"><li *ngFor="let item of questionCountBySubject() | keyvalue" class="list-group-item d-flex justify-content-between align-items-center">{{ item.key }} <span class="badge bg-primary rounded-pill">{{ item.value }}</span></li></ul>
            </div>
          </div>
        </div>
        <!-- By Chapter -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingChapter">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChapter" aria-expanded="false" aria-controls="collapseChapter">
              By Chapter ({{ questionCountByChapter().size }})
            </button>
          </h2>
          <div id="collapseChapter" class="accordion-collapse collapse" aria-labelledby="headingChapter" data-bs-parent="#statsAccordion">
            <div class="accordion-body" style="max-height: 300px; overflow-y: auto;">
              <ul class="list-group list-group-flush"><li *ngFor="let item of questionCountByChapter() | keyvalue" class="list-group-item d-flex justify-content-between align-items-center">{{ item.key }} <span class="badge bg-success rounded-pill">{{ item.value }}</span></li></ul>
            </div>
          </div>
        </div>
        <!-- By Type -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingType">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseType" aria-expanded="false" aria-controls="collapseType">
              By Type ({{ questionCountByType().size }})
            </button>
          </h2>
          <div id="collapseType" class="accordion-collapse collapse" aria-labelledby="headingType" data-bs-parent="#statsAccordion">
            <div class="accordion-body"><ul class="list-group list-group-flush"><li *ngFor="let item of questionCountByType() | keyvalue" class="list-group-item d-flex justify-content-between align-items-center">{{ item.key }} <span class="badge bg-warning text-dark rounded-pill">{{ item.value }}</span></li></ul></div>
          </div>
        </div>
        <!-- By Teacher -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingTeacher">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTeacher" aria-expanded="false" aria-controls="collapseTeacher">
              By Teacher ({{ questionCountByTeacher().size }})
            </button>
          </h2>
          <div id="collapseTeacher" class="accordion-collapse collapse" aria-labelledby="headingTeacher" data-bs-parent="#statsAccordion">
            <div class="accordion-body"><ul class="list-group list-group-flush"><li *ngFor="let item of questionCountByTeacher() | keyvalue" class="list-group-item d-flex justify-content-between align-items-center">{{ item.key }} <span class="badge bg-secondary rounded-pill">{{ item.value }}</span></li></ul></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading()" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading questions...</p>
  </div>

  <div *ngIf="!isLoading() && totalQuestions() > 0" class="d-flex justify-content-between align-items-center mb-3">
    <span class="text-muted">
      Showing {{ approvedQuestions().length }} of {{ totalQuestions() }} questions
      (Page {{ currentPage() }})
    </span>
  </div>


  <div *ngIf="error()" class="alert alert-danger">
    <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ error() }}
  </div>

  <div *ngIf="!isLoading() && !error() && approvedQuestions().length === 0" class="alert alert-info">
    <i class="bi bi-info-circle-fill me-2"></i> No approved questions are available matching your criteria.
  </div>

  <div *ngIf="!isLoading() && approvedQuestions().length > 0" class="list-group">
    <div *ngFor="let q of approvedQuestions()" class="list-group-item list-group-item-action flex-column align-items-start mb-3 shadow-sm rounded-3 border-start border-primary border-4">
      <div class="d-flex w-100 justify-content-between">
        <h5 class="mb-1 fw-bold">{{ q.subject }} - {{ q.chapter }} (Class {{ q.questionClass }})</h5>
        <small class="text-muted" *ngIf="q.createdAt">{{ q.createdAt?.toDate() | date:'shortDate' }}</small>
      </div>

      <!-- Question Content based on Type -->
      <div class="py-2" [ngSwitch]="q.questionType">
        <!-- Multiple Choice -->
        <div *ngSwitchCase="'Multiple Choice'">
          <p class="mb-3" style="white-space: pre-wrap;">{{ q.question }}</p>
          <div class="list-group">
            <label *ngFor="let option of q.options; let i = index" class="list-group-item list-group-item-action">
              <input class="form-check-input me-2" type="radio" [name]="q.id" disabled> {{ option }}
            </label>
          </div>
        </div>

        <!-- True/False -->
        <div *ngSwitchCase="'True/False'">
          <p class="mb-3" style="white-space: pre-wrap;">{{ q.question }}</p>
          <div class="list-group">
            <label class="list-group-item list-group-item-action"><input class="form-check-input me-2" type="radio" [name]="q.id" disabled> True</label>
            <label class="list-group-item list-group-item-action"><input class="form-check-input me-2" type="radio" [name]="q.id" disabled> False</label>
          </div>
        </div>

        <!-- Fill in the Blanks -->
        <div *ngSwitchCase="'Fill in the Blanks'">
          <p class="mb-2" style="white-space: pre-wrap;" [innerHTML]="getFillInTheBlanksQuestion(q.question)"></p>
        </div>

        <!-- Multiple Response -->
        <div *ngSwitchCase="'Multiple Response'">
          <p class="mb-3" style="white-space: pre-wrap;">{{ q.question }}</p>
          <div class="list-group">
            <label *ngFor="let option of q.options; let i = index" class="list-group-item list-group-item-action">
              <input class="form-check-input me-2" type="checkbox" disabled> {{ option }}
            </label>
          </div>
        </div>

        <!-- Default for Short Answer, Essay, etc. -->
        <p *ngSwitchDefault class="mb-2" style="white-space: pre-wrap;">{{ q.question }}</p>
      </div>

      <small class="text-muted d-block"><strong>Type:</strong> {{ q.questionType }}</small>
      <small class="text-muted"><strong>By:</strong> {{ q.teacherName }}</small>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div *ngIf="!isLoading() && totalQuestions() > pageSize" class="d-flex justify-content-center mt-4">
    <nav aria-label="Question bank pagination">
      <ul class="pagination">
        <li class="page-item" [class.disabled]="currentPage() === 1">
          <button class="page-link" (click)="goToPrevPage()" [disabled]="currentPage() === 1">Previous</button>
        </li>
        <li class="page-item" [class.disabled]="isLastPage()">
          <button class="page-link" (click)="goToNextPage()" [disabled]="isLastPage()">Next</button>
        </li>
      </ul>
    </nav>
  </div>
</div>